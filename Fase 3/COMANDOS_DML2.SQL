--BLOCO ANONIMO PARA POPULAR TABELA DE OCORRENCIA DO SAC
DECLARE
--CRIADO 2 VARIAVEIS PARA ARMAZENAR A SIGLA DO ESTADO E NOME DO ESTADO;
V_SG_ESTADO MC_ESTADO.SG_ESTADO%TYPE;
V_NM_ESTADO MC_ESTADO.NM_ESTADO%TYPE;

--CRIADO VARIAVEL PARA O CALCULO DA PORCENTAGEM DE ICMS POR ESTADO
VL_PERC_ICMS_ESTADO FLOAT(10);

--CRIADO VARIAVEL PARA O CALCULO DA PORCENTAGEM DE ICMS POR PRODUTO
VL_ICMS_PRODUTO FLOAT(10);

--CRIADO CURSOR PARA RESGATAR AS INFORMA«’ES DAS TABELAS DE SAC, PRODUTO E CLIENTE
CURSOR SAC IS
         SELECT
                    SAC.NR_SAC
                ,   SAC.DT_ABERTURA_SAC
                ,   SAC.HR_ABERTURA_SAC
                ,   (CASE WHEN SAC.TP_SAC = 'S' THEN 'SUGESTAO' WHEN SAC.TP_SAC = 'D' THEN 'DUVIDA'
                    WHEN SAC.TP_SAC = 'E' THEN 'ELOGIO' ELSE 'CLASSIFICACAO INVALIDA' END) AS DS_TIPO_CLASSIFICACAO_SAC
                ,   PRO.CD_PRODUTO
                ,   PRO.DS_PRODUTO
                ,   PRO.VL_UNITARIO AS VL_UNITARIO_PRODUTO
                ,   PRO.VL_PERC_LUCRO
                ,   CLI.NR_CLIENTE
                ,   CLI.NM_CLIENTE
                ,   ((PRO.VL_PERC_LUCRO / 100) * PRO.VL_UNITARIO) AS VL_UNITARIO_LUCRO_PRODUTO 
                FROM MC_SGV_SAC SAC
                LEFT JOIN MC_PRODUTO PRO ON PRO.CD_PRODUTO = SAC.CD_PRODUTO
                LEFT JOIN MC_CLIENTE CLI ON CLI.NR_CLIENTE = SAC.NR_CLIENTE;
        
BEGIN

--CRIADO LOOP FOR PARA RESGATAR OS ESTADOS DE ACORDO COM O CLIENTE UTILIZANDO INSERT INTO, CONFORME MANDA O ENUNCIADO 
    FOR S IN SAC LOOP
        SELECT EST.SG_ESTADO, EST.NM_ESTADO 
               INTO V_SG_ESTADO, V_NM_ESTADO
               FROM MC_CLIENTE CLI
               LEFT JOIN MC_END_CLI END ON END.NR_CLIENTE = CLI.NR_CLIENTE
               LEFT JOIN MC_LOGRADOURO LOG ON LOG.CD_LOGRADOURO = CD_LOGRADOURO_CLI
               LEFT JOIN MC_BAIRRO BAI ON BAI.CD_BAIRRO = LOG.CD_BAIRRO
               LEFT JOIN MC_CIDADE CID ON CID.CD_CIDADE = BAI.CD_CIDADE
               LEFT JOIN MC_ESTADO EST ON EST.SG_ESTADO = CID.SG_ESTADO
               WHERE CLI.NR_CLIENTE = S.NR_CLIENTE; 
               
    --CALCULANDO VALORES DO ICMS POR ESTADO E DO PRODUTO
            VL_PERC_ICMS_ESTADO := PF0110.FUN_MC_GERA_ALIQUOTA_MEDIA_ICMS_ESTADO(V_SG_ESTADO);   
            VL_ICMS_PRODUTO :=  ((VL_PERC_ICMS_ESTADO / 100) * S.VL_UNITARIO_PRODUTO);
            
--INSERINDO OS VALORES NA TABELA DE OCORRENCIA DO SAC
           INSERT INTO MC_SGV_OCORRENCIA_SAC (
             NR_OCORRENCIA_SAC,
             DT_ABERTURA_SAC,
             HR_ABERTURA_SAC,
             DS_TIPO_CLASSIFICACAO_SAC,
             CD_PRODUTO, 
             DS_PRODUTO,
             VL_UNITARIO_PRODUTO,
             VL_PERC_LUCRO,
             VL_UNITARIO_LUCRO_PRODUTO,
             SG_ESTADO, 
             NM_ESTADO, 
             NR_CLIENTE, 
             NM_CLIENTE, 
             VL_ICMS_PRODUTO)
         VALUES ( 
             S.NR_SAC,
             S.DT_ABERTURA_SAC,
             S.HR_ABERTURA_SAC,
             S.DS_TIPO_CLASSIFICACAO_SAC,
             S.CD_PRODUTO,
             S.DS_PRODUTO,
             S.VL_UNITARIO_PRODUTO,
             S.VL_PERC_LUCRO,
             S.VL_UNITARIO_PRODUTO,
             V_SG_ESTADO,
             V_NM_ESTADO,
             S.NR_CLIENTE,
             S.NM_CLIENTE,
             VL_ICMS_PRODUTO);
            
    END LOOP;
    
    --CONFIRMANDO TODAS AS TRANSA«’ES REALIZADAS ATRAVES DO COMMIT;
    COMMIT;
    
END;
/



/*
--POPULANDO TABELA SAC PARA REALIZA√á√ÉO DE TESTES.
INSERT INTO MC_SGV_SAC(NR_SAC, NR_CLIENTE, CD_PRODUTO, CD_FUNCIONARIO,  DS_DETALHADA_SAC, DT_ABERTURA_SAC, HR_ABERTURA_SAC, DT_ATENDIMENTO, HR_ATENDIMENTO_SAC, DS_DETALHADA_RETORNO_SAC, TP_SAC, ST_SAC)
    VALUES(SQ_MC_SGV_SAC.NEXTVAL,2,12,37,'Jogo n√£o roda no meu PS10.', TO_DATE('01/04/2023','DD/MM/YYYY'),8,TO_DATE('01/04/2023','DD/MM/YYYY'),9,'Foi orientado o cliente a soprar suavemente o cd e tentar novamente.','D','E');

INSERT INTO MC_SGV_SAC(NR_SAC, NR_CLIENTE, CD_PRODUTO, CD_FUNCIONARIO,  DS_DETALHADA_SAC, DT_ABERTURA_SAC, HR_ABERTURA_SAC, DT_ATENDIMENTO, HR_ATENDIMENTO_SAC, DS_DETALHADA_RETORNO_SAC, TP_SAC, ST_SAC)
    VALUES(SQ_MC_SGV_SAC.NEXTVAL,3,4,37,'Celular travando com frequ√™ncia.', TO_DATE('03/05/2023','DD/MM/YYYY'),11,TO_DATE('03/05/2023','DD/MM/YYYY'),12,'Foi esclaredico ao cliente que √© normal da marca do aparelho.','D','E');

INSERT INTO MC_SGV_SAC(NR_SAC, NR_CLIENTE, CD_PRODUTO, CD_FUNCIONARIO,  DS_DETALHADA_SAC, DT_ABERTURA_SAC, HR_ABERTURA_SAC, DT_ATENDIMENTO, HR_ATENDIMENTO_SAC, DS_DETALHADA_RETORNO_SAC, TP_SAC, ST_SAC)
    VALUES(SQ_MC_SGV_SAC.NEXTVAL,7,2,38,'Meias super confort√°veis.', TO_DATE('10/05/2023','DD/MM/YYYY'),15,TO_DATE('10/05/2023','DD/MM/YYYY'),16,'Elogio registrado no SAC e destacado nos coment√°rio dos produtos.','E','E');
*/


