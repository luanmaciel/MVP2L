/* Fiz a chamada da função direto, sem utilizar um subselect, mas se quiserem mudar podem mudar, o que ficar melhor para vocês.
   Acho que tá tudo aí, se acharem um jeito melhor de fazer podem mudar ou se eu fiz algo que está diferente da tarefa também.
   Mas pelo o que eu entendi das instruções é isso aí o select.
   Não vou conseguir me reunir com vocês hoje, mas durante a semana a gente faz uma call para organizar as coisas melhor e discutir mudanças.
*/

SELECT
    T.*
,   ((T.VL_PERC_ICMS_ESTADO / 100) * T.VL_UNITARIO_PRODUTO) AS VL_ICMS_PRODUTO
FROM (
        SELECT
            SAC.NR_SAC
        ,   SAC.DT_ABERTURA_SAC
        ,   SAC.HR_ABERTURA_SAC
        ,   (CASE WHEN SAC.TP_SAC = 'S' THEN 'SUGESTÃO' WHEN SAC.TP_SAC = 'D' THEN 'DÚVIDA'
            WHEN SAC.TP_SAC = 'E' THEN 'ELOGIO' ELSE 'CLASSIFICAÇÃO INVÁLIDA' END) AS DS_TIPO_CLASSIFICACAO_SAC
        ,   PRO.CD_PRODUTO
        ,   PRO.DS_PRODUTO
        ,   PRO.VL_UNITARIO AS VL_UNITARIO_PRODUTO
        ,   PRO.VL_PERC_LUCRO
        ,   CLI.NR_CLIENTE
        ,   CLI.NM_CLIENTE
        ,   EST.SG_ESTADO
        ,   EST.NM_ESTADO
        ,   ((PRO.VL_PERC_LUCRO / 100) * PRO.VL_UNITARIO) AS VL_UNITARIO_LUCRO_PRODUTO
        ,   PF0110.FUN_MC_GERA_ALIQUOTA_MEDIA_ICMS_ESTADO('SC') AS VL_PERC_ICMS_ESTADO
        FROM MC_SGV_SAC SAC
        LEFT JOIN MC_PRODUTO PRO ON PRO.CD_PRODUTO = SAC.CD_PRODUTO
        LEFT JOIN MC_CLIENTE CLI ON CLI.NR_CLIENTE = SAC.NR_CLIENTE
        LEFT JOIN MC_END_CLI END ON END.NR_CLIENTE = CLI.NR_CLIENTE
        LEFT JOIN MC_LOGRADOURO LOG ON LOG.CD_LOGRADOURO = CD_LOGRADOURO_CLI
        LEFT JOIN MC_BAIRRO BAI ON BAI.CD_BAIRRO = LOG.CD_BAIRRO
        LEFT JOIN MC_CIDADE CID ON CID.CD_CIDADE = BAI.CD_CIDADE
        LEFT JOIN MC_ESTADO EST ON EST.SG_ESTADO = CID.SG_ESTADO
        ) T
